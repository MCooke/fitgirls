/**
 * AJAX Upload
 * Project page - http://valums.com/ajax-upload/
 * Copyright (c) 2008 Andris Valums, http://valums.com
 * Licensed under the MIT license (http://valums.com/mit-license/)
 */
(function(){function c(b){return"string"==typeof b&&(b=a.getElementById(b)),b}function d(a,c,d){if(b.addEventListener)a.addEventListener(c,d,!1);else if(b.attachEvent){var e=function(){d.call(a,b.event)};a.attachEvent("on"+c,e)}}function f(a,b){return a.className.match(RegExp("(\\s|^)"+b+"(\\s|$)"))}function g(a,b){f(a,b)||(a.className+=" "+b)}function h(a,b){var c=RegExp("(\\s|^)"+b+"(\\s|$)");a.className=a.className.replace(c," ")}function j(a){var b,c,d,e,f=i(a);return b=f.left,d=f.top,c=b+a.offsetWidth,e=d+a.offsetHeight,{left:b,right:c,top:d,bottom:e}}function k(b){if(!b.pageX&&b.clientX){var c=1,d=document.body;if(d.getBoundingClientRect){var e=d.getBoundingClientRect();c=(e.right-e.left)/d.clientWidth}return{x:b.clientX/c+a.body.scrollLeft+a.documentElement.scrollLeft,y:b.clientY/c+a.body.scrollTop+a.documentElement.scrollTop}}return{x:b.pageX,y:b.pageY}}function m(a){return a.replace(/.*(\/|\\)/,"")}function n(a){return/[.]/.exec(a)?/[^.]+$/.exec(a.toLowerCase()):""}var a=document,b=window,e=function(){var b=a.createElement("div");return function(a){b.innerHTML=a;var c=b.childNodes[0];return b.removeChild(c),c}}();if(document.documentElement.getBoundingClientRect)var i=function(a){var b=a.getBoundingClientRect(),c=a.ownerDocument,d=c.body,e=c.documentElement,f=e.clientTop||d.clientTop||0,g=e.clientLeft||d.clientLeft||0,h=1;if(d.getBoundingClientRect){var i=d.getBoundingClientRect();h=(i.right-i.left)/d.clientWidth}h>1&&(f=0,g=0);var j=b.top/h+(window.pageYOffset||e&&e.scrollTop/h||d.scrollTop/h)-f,k=b.left/h+(window.pageXOffset||e&&e.scrollLeft/h||d.scrollLeft/h)-g;return{top:j,left:k}};else var i=function(a){if(b.jQuery)return jQuery(a).offset();var c=0,d=0;do c+=a.offsetTop||0,d+=a.offsetLeft||0;while(a=a.offsetParent);return{left:d,top:c}};var l=function(){var a=0;return function(){return"ValumsAjaxUpload"+a++}}(),o=function(){var a;return function(){if(a)return a;if("undefined"!=typeof XMLHttpRequest)a=new XMLHttpRequest;else for(var b=["Microsoft.XmlHttp","MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0"],c=0;b.length>c;c++)try{a=new ActiveXObject(b[c]);break}catch(d){}return a}}();Ajax_upload=AjaxUpload=function(b,d){if(b.jquery?b=b[0]:"string"==typeof b&&/^#.*/.test(b)&&(b=b.slice(1)),b=c(b),this._input=null,this._button=b,this._disabled=!1,this._submitting=!1,this._justClicked=!1,this._parentDialog=a.body,window.jQuery&&jQuery.ui&&jQuery.ui.dialog){var e=jQuery(this._button).parents(".ui-dialog");e.length&&(this._parentDialog=e[0])}this._settings={action:"upload.php",name:"userfile",data:{},autoSubmit:!0,responseType:!1,closeConnection:"",hoverClass:"hover",onChange:function(){},onSubmit:function(){},onComplete:function(){}};for(var f in d)this._settings[f]=d[f];this._createInput(),this._rerouteClicks()},AjaxUpload.prototype={setData:function(a){this._settings.data=a},disable:function(){this._disabled=!0},enable:function(){this._disabled=!1},destroy:function(){this._input&&(this._input.parentNode&&this._input.parentNode.removeChild(this._input),this._input=null)},_createInput:function(){var b=this,c=a.createElement("input");c.setAttribute("type","file"),c.setAttribute("name",this._settings.name);var e={position:"absolute",margin:"-5px 0 0 -175px",padding:0,width:"220px",height:"30px",fontSize:"14px",opacity:0,cursor:"pointer",display:"none",zIndex:2147483583};for(var f in e)c.style[f]=e[f];"0"!==c.style.opacity&&(c.style.filter="alpha(opacity=0)"),this._parentDialog.appendChild(c),d(c,"change",function(){var a=m(this.value);0!=b._settings.onChange.call(b,a,n(a))&&b._settings.autoSubmit&&b.submit()}),d(c,"click",function(){b.justClicked=!0,setTimeout(function(){b.justClicked=!1},2500)}),this._input=c},_rerouteClicks:function(){var c,b=this,e={top:0,left:0},f=!1;d(b._button,"mouseover",function(){b._input&&!f&&(f=!0,c=j(b._button),b._parentDialog!=a.body&&(e=i(b._parentDialog)))}),d(document,"mousemove",function(a){var d=b._input;if(d&&f){if(b._disabled)return h(b._button,b._settings.hoverClass),d.style.display="none",void 0;var i=k(a);if(i.x>=c.left&&i.x<=c.right&&i.y>=c.top&&i.y<=c.bottom)d.style.top=i.y-e.top+"px",d.style.left=i.x-e.left+"px",d.style.display="block",g(b._button,b._settings.hoverClass);else{f=!1;var j=setInterval(function(){b.justClicked||(f||(d.style.display="none"),clearInterval(j))},25);h(b._button,b._settings.hoverClass)}}})},_createIframe:function(){var b=l(),c=e('<iframe src="javascript:false;" name="'+b+'" />');return c.id=b,c.style.display="none",a.body.appendChild(c),c},submit:function(){var b=this,c=this._settings;if(""!==this._input.value){var e=m(this._input.value);if(0!=c.onSubmit.call(this,e,n(e))){var f=this._createIframe(),g=this._createForm(f);if(g.appendChild(this._input),c.closeConnection&&/AppleWebKit|MSIE/.test(navigator.userAgent)){var h=o();h.open("GET",c.closeConnection,!1),h.send("")}g.submit(),a.body.removeChild(g),g=null,this._input=null,this._createInput();var i=!1;d(f,"load",function(){if("javascript:'%3Chtml%3E%3C/html%3E';"==f.src||"javascript:'<html></html>';"==f.src)return i&&setTimeout(function(){a.body.removeChild(f)},0),void 0;var g=f.contentDocument?f.contentDocument:frames[f.id].document;if(!(g.readyState&&"complete"!=g.readyState||g.body&&"false"==g.body.innerHTML)){var h;if(g.XMLDocument)h=g.XMLDocument;else if(g.body)h=g.body.innerHTML,c.responseType&&"json"==c.responseType.toLowerCase()&&(g.body.firstChild&&"PRE"==g.body.firstChild.nodeName.toUpperCase()&&(h=g.body.firstChild.firstChild.nodeValue),h=h?window.eval("("+h+")"):{});else var h=g;c.onComplete.call(b,e,h),i=!0,f.src="javascript:'<html></html>';"}})}else a.body.removeChild(this._input),this._input=null,this._createInput()}},_createForm:function(b){var c=this._settings,d=e('<form method="post" enctype="multipart/form-data"></form>');d.style.display="none",d.action=c.action,d.target=b.name,a.body.appendChild(d);for(var f in c.data){var g=a.createElement("input");g.type="hidden",g.name=f,g.value=c.data[f],d.appendChild(g)}return d}}})();